<aura:component
  controller="Einstein_PlaygroundController"
  extends="EinsteinPlaygroundBase"
  access="global"
>
  <aura:attribute name="dataType" type="String"></aura:attribute>
  <aura:attribute name="datasets" type="Einstein_Dataset[]"></aura:attribute>
  <aura:attribute name="datasetModels" type="Einstein_Model[]"></aura:attribute>
  <aura:attribute name="selectedDataset" type="String" />
  <aura:attribute name="selectedAlgorithm" type="string" default="intent"/>

  <!-- Table decorators.  Set by onLoadDatasets -->
  <aura:attribute name="iconName" type="String"></aura:attribute>
  <aura:attribute name="title" type="String"></aura:attribute>

  <!-- Events -->
  <aura:registerEvent name="waitingEvent" type="c:EventEinsteinWaiting" />
  <aura:handler
    name="databaseEvent"
    event="c:EventEinsteinDataset"
    action="{!c.onLoadDatasets}"
  />
  <aura:handler event="ltng:sendMessage" action="{!c.messageHandler}" />
  <aura:handler name="init" value="{!this}" action="{!c.onLoadDatasets}" />

  <lightning:layout multipleRows="true">
    <lightning:layoutitem size="8" padding="around-small">
      <lightning:layout class="layoutBorder" multipleRows="true">
        <lightning:layoutitem
          size="12"
          class="datasetHeader"
          padding="around-small"
        >
          <lightning:layout>
            <lightning:layoutitem size="1" class="datasetHeader">
              <lightning:icon
                iconName="{!v.iconName}"
                alternativeText="Datasets"
              />
            </lightning:layoutitem>
            <lightning:layoutitem size="10" class="datasetHeader">
              <span class="slds-text-heading_medium">
                {!v.title} Datasets
              </span>
            </lightning:layoutitem>
            <lightning:layoutitem size="1" class="datasetHeader">
              <lightning:buttonIcon
                iconName="utility:refresh"
                variant="border-filled"
                onclick="{!c.onLoadDatasets}"
                alternativeText="Refresh"
              />
            </lightning:layoutitem>
          </lightning:layout>
        </lightning:layoutitem>

        <lightning:layoutitem size="12" padding="around-small">
          <!-- Dataset table list -->
          <table class="slds-table slds-table_bordered slds-table_cell-buffer">
            <thead>
              <tr class="slds-text-title_caps">
                <th scope="col">
                  <div class="slds-truncate" title="Name">Name</div>
                </th>
                <th scope="col">
                  <div class="slds-truncate" title="Id">Id</div>
                </th>
                <!-- Language header for intent datasets only -->
                <aura:if isTrue="{!v.dataType == 'text-intent'}">
                  <th scope="col">
                    <div class="slds-truncate" title="Id">Language</div>
                  </th>
                </aura:if>
                <th scope="col">
                  <div class="slds-truncate" title="Created">Created</div>
                </th>
                <th scope="col">
                  <div class="slds-truncate" title="Updated">Updated</div>
                </th>
                <th scope="col">
                  <div class="slds-truncate" title="Status">Status</div>
                </th>
                <th scope="col">
                  <div class="slds-truncate" title="Action"></div>
                </th>
              </tr>
            </thead>

            <tbody>
              <aura:iteration items="{!v.datasets}" var="item">
                <tr>
                  <td data-label="Name">
                    <div class="slds-truncate" title="{!item.name}">
                      <lightning:button
                        variant="base"
                        label="{!item.name}"
                        onclick="{!c.getSelectedRow}"
                        name="{!item.id}"
                    /></div>
                  </td>
                  <td data-label="Id">
                    <div class="slds-truncate" title="{!item.id}"
                      >{!item.id}</div
                    >
                  </td>
                  <!-- Language value for intent datasets only -->
                  <aura:if isTrue="{!v.dataType == 'text-intent'}">
                    <td data-label="Language">
                      <div class="slds-truncate" title="{!item.language}"
                        >{!item.language}</div
                      >
                    </td>
                  </aura:if>
                  <td data-label="createdAt">
                    <div class="slds-truncate" title="{!item.createdAt}"
                      ><lightning:formattedDateTime value="{!item.createdAt}"
                    /></div>
                  </td>
                  <td data-label="updatedAt">
                    <div class="slds-truncate" title="{!item.updatedAt}"
                      ><lightning:formattedDateTime value="{!item.updatedAt}"
                    /></div>
                  </td>
                  <td data-label="statusMsg">
                    <div class="slds-truncate" title="{!item.statusMsg}"
                      >{!item.statusMsg}
                    </div>
                  </td>
                  <td data-label="updatedAt">
                    <lightning:buttonMenu
                      name="{!item.id}"
                      onselect="{! c.handleMenuSelect }"
                      alternativeText="Show menu"
                    >
                      <!-- Details menu in the version at https://github.com/mbrosseau/salesforce-einstein-platform-apex 
                            takes you to a page where you can also do predictions as well as set updates (feedback).
                            Unfortunately, it doesn't seem to be fully baked.  The Retrain link throws a script-thrown
                            exception.  Since it isn't working, I am commenting out the call for now.  Maybe a future
                            release can add it. -->
                      <!-- <lightning:menuItem value="details" label="Details" /> -->
                      <lightning:menuItem value="train" label="Train" />
                      <lightning:menuItem value="delete" label="Delete" />
                    </lightning:buttonMenu>
                  </td>
                </tr>
              </aura:iteration>
            </tbody>
          </table>
        </lightning:layoutitem>
      </lightning:layout>
    </lightning:layoutitem>

    <!-- Details block for selected dataset -->
    <lightning:layoutitem size="4" padding="around-small">
      <aura:if isTrue="{!v.selectedDataset != null}">
        <c:EinsteinDataset
          dataset="{!v.selectedDataset}"
          dataType="{!v.dataType}"
          aura:id="cDataset"
        />
      </aura:if>
    </lightning:layoutitem>
  </lightning:layout>

  <!-- Modal that prompts for training algorithm -->
  <section
    role="dialog"
    tabindex="-1"
    class="slds-modal slds-modal_small"
    aria-labelledby="modal-heading-01"
    aria-modal="true"
    aura:id="myModal"
    aria-describedby="modal-content-id-1"
  >
    <div class="slds-modal__container">
      <header class="slds-modal__header">
        <lightning:buttonIcon iconName="utility:close"
                                              onclick="{! c.closeModel }"
                                              alternativeText="close"
                                              variant="bare-inverse"
                                              class="slds-modal__close"/>
        <h2 id="modal-heading-01" class="slds-modal__title slds-hyphenate">Intent V2 Algorithm</h2>
      </header>
      <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
        <p>You use the algorithm parameter when you train a dataset to create a model using Intent V2. This optional
          parameter specifies the algorithm used to train the dataset. Valid values are:</p>
          <br/>
        <ul>
          <li>
            <p><b>intent</b> — Uses the original training algorithm.</p>
          </li>
          <li>
            <p><b>multilingual-intent</b> — Uses the training algorithm that supports multiple languages.
              A model created using this algorithm returns one of the model labels, even if the text sent
              for prediction doesn’t fall into any of the labels.</p>
          </li>
          <li>
            <p><b>multilingual-intent-ood</b>— Uses the training algorithm that supports multiple
              languages and handles out-of-domain text. A model created using this algorithm returns
              an empty probabilities array when text sent for prediction doesn’t fall into one of the
              labels.</p> 
          </li>
        </ul>
        <br/>
        <p><b>Tip:</b> Even if your dataset language is English, we recommend that you use either the
          multilingual-intent or multilingual-intent-ood algorithm for better results.</p>
        <c:EinsteinAlgorithmSelect selectedAlgorithm="{!v.selectedAlgorithm}"/>
      </div>
      <footer class="slds-modal__footer">
        <lightning:button variant="neutral"
                                          label="Cancel"
                                          title="Cancel"
                                          onclick="{! c.closeModal }"/>
        <lightning:button variant="brand"
                                          label="Train"
                                          title="Train"
                                          onclick="{! c.trainIntentV2Model }"/>
      </footer>
    </div>
  </section>
  <div class="slds-backdrop " aura:id="myModal-Back"></div>
</aura:component>
